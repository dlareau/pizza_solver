{% extends "webapp/base.html" %}
{% block title %}Order from {{ order.restaurant }}{% endblock %}

{% block content %}
<h1 class="title">Order from {{ order.restaurant }}</h1>
<p class="subtitle">Set your topping preferences for this pizza order.</p>

{% if already_solved %}
<div class="notification is-warning is-light">
  <p>This order has already been completed. No more preferences can be submitted.</p>
</div>
<p><a class="button is-light mt-2" href="/">Home</a></p>

{% elif guest %}

{# Returning guest — edit preferences #}
<p class="mb-4">Welcome back, <strong>{{ guest.name }}</strong>! Update your preferences below.</p>

<form method="post" style="max-width:680px;">
  {% csrf_token %}
  {% if toppings %}<h2 class="subtitle mb-2">Topping Preferences</h2>{% endif %}
  {% include "webapp/guests/_topping_prefs.html" %}
  <div class="field mt-5">
    <div class="control">
      <button class="button is-primary" type="submit">Save Preferences</button>
    </div>
  </div>
</form>

{% else %}

{# New guest — name + preferences #}
{% if error %}
<div class="notification is-danger is-light mb-3">{{ error }}</div>
{% endif %}

<form method="post" style="max-width:680px;">
  {% csrf_token %}
  <div class="field">
    <label class="label">Your Name</label>
    <div class="control">
      <input class="input{% if error %} is-danger{% endif %}" type="text" name="name"
             placeholder="Your name" required autofocus>
    </div>
  </div>
  {% if toppings %}<h2 class="subtitle mb-2 mt-4">Topping Preferences</h2>{% endif %}
  {% include "webapp/guests/_topping_prefs.html" %}
  <div class="field mt-5">
    <div class="control">
      <button class="button is-primary" type="submit">Submit Preferences</button>
    </div>
  </div>
</form>

{% endif %}

<script>
(function () {
  var COLOR = { '-2': 'is-danger', '-1': 'is-warning', '0': 'is-info', '1': 'is-success' };

  document.querySelectorAll('.buttons[data-topping]').forEach(function (group) {
    var hidden = document.querySelector('input[name="pref_' + group.dataset.topping + '"]');

    group.querySelectorAll('.pref-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var val = btn.dataset.value;

        group.querySelectorAll('.pref-btn').forEach(function (b) {
          b.className = 'button is-small pref-btn is-light';
        });

        btn.classList.remove('is-light');
        btn.classList.add(COLOR[val]);

        hidden.value = val;
      });
    });
  });
}());
</script>
{% endblock %}
