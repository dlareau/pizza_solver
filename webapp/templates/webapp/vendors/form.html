{% extends "webapp/base.html" %}
{% block title %}{{ action }} Vendor{% endblock %}

{% block content %}
<h1 class="title">{{ action }} Vendor</h1>

{% if not selected_group %}

{# Group picker step #}
<form method="get" action="" style="max-width: 400px;">
  <div class="field">
    <label class="label">Select a Group</label>
    <div class="control">
      <div class="select is-fullwidth">
        <select name="group">
          <option value="">-- Select a group --</option>
          {% for group in groups %}
          <option value="{{ group.pk }}">{{ group.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
  <div class="field">
    <div class="control">
      <button class="button is-primary" type="submit">Continue</button>
      <a class="button is-light ml-2" href="{% url 'vendor_list' %}">Cancel</a>
    </div>
  </div>
</form>

{% else %}

{# Vendor form #}
<p class="mb-4">
  <strong>Group:</strong> {{ selected_group.name }}
  {% if can_change_group %}
  <a class="ml-3 is-size-7" href="{% url 'vendor_create' %}">Change group</a>
  {% endif %}
</p>

<form method="post" style="max-width: 560px;">
  {% csrf_token %}
  {% if action == 'Create' %}
  <input type="hidden" name="group" value="{{ selected_group.pk }}">
  {% endif %}

  {% if form.non_field_errors %}
  <div class="notification is-danger is-light">
    {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
  </div>
  {% endif %}

  <div class="field">
    <label class="label" for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
    <div class="control">
      <input class="input{% if form.name.errors %} is-danger{% endif %}"
             type="text"
             name="{{ form.name.html_name }}"
             id="{{ form.name.id_for_label }}"
             value="{{ form.name.value|default:'' }}">
    </div>
    {% if form.name.errors %}
    <p class="help is-danger">{% for e in form.name.errors %}{{ e }}{% endfor %}</p>
    {% endif %}
  </div>

  <div class="field">
    <label class="label">Toppings</label>
    <div class="control">
      <div id="toppings-tags"
           style="display:flex; flex-wrap:wrap; gap:0.4rem;
                  border:1px solid #dbdbdb; border-radius:4px; padding:0.5rem;">
        {% for choice in form.toppings %}
        <label style="cursor:pointer; margin:0;">
          <span class="tag is-medium is-light topping-tag">{{ choice.choice_label }}</span>
          <span style="display:none;">{{ choice.tag }}</span>
        </label>
        {% empty %}
        <p class="has-text-grey-light">No toppings available. Ask a staff member to add toppings first.</p>
        {% endfor %}
      </div>
    </div>
    {% if form.toppings.errors %}
    <p class="help is-danger">{% for e in form.toppings.errors %}{{ e }}{% endfor %}</p>
    {% endif %}
  </div>

<script>
(function () {
  document.querySelectorAll('#toppings-tags label').forEach(function (lbl) {
    var cb = lbl.querySelector('input[type="checkbox"]');
    var tag = lbl.querySelector('.topping-tag');
    if (cb && cb.checked) {
      tag.classList.replace('is-light', 'is-link');
    }
    lbl.addEventListener('click', function (e) {
      e.preventDefault();
      cb.checked = !cb.checked;
      if (cb.checked) {
        tag.classList.replace('is-light', 'is-link');
      } else {
        tag.classList.replace('is-link', 'is-light');
      }
    });
  });
}());
</script>

  <div class="field is-grouped">
    <div class="control">
      <button class="button is-primary" type="submit">{{ action }}</button>
    </div>
    <div class="control">
      <a class="button is-light" href="{% url 'vendor_list' %}">Cancel</a>
    </div>
  </div>
</form>

{% endif %}
{% endblock %}
