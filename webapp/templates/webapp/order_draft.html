{% extends "webapp/base.html" %}
{% load static %}
{% block title %}New Pizza Order{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/htmx.org@2.0.4/dist/htmx.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% endblock %}

{% block content %}
{% include "webapp/_order_page_header.html" %}

<div class="box" style="max-width:560px;">
  <h3 class="subtitle is-6 mb-2">One-Time Guest Link</h3>
  <p class="help mb-3">Share this link with one-time guests to set their topping preferences. For regular guests, invite them to the group instead.</p>
  <div class="field has-addons">
    <div class="control is-expanded">
      <input id="invite-link" class="input is-small" type="text" readonly value="{{ invite_url }}">
    </div>
    <div class="control">
      <button class="button is-info is-small" type="button"
              onclick="navigator.clipboard.writeText(document.getElementById('invite-link').value);
                       this.textContent='Copied!';setTimeout(()=>this.textContent='Copy',2000);">
        Copy
      </button>
    </div>
  </div>
  <div id="qr-section" class="mt-3" style="display:none;">
    <div id="qr-canvas"></div>
  </div>
</div>

{# Restaurant locked section - separate form to avoid nesting #}
<div class="field" style="max-width:560px;">
  <label class="label">Restaurant</label>
  <div class="is-flex is-align-items-center" style="gap: 0.75rem;">
    <span class="is-size-6">{{ proto_order.restaurant }}</span>
    <form method="post" action="{% url 'order_cancel_invite' proto_order.id %}"
          onsubmit="return confirm('Switching restaurant will remove all guests and their preferences. Are you sure?');"
          style="display:inline; margin:0;">
      {% csrf_token %}
      <button class="button is-warning is-outlined is-small" type="submit">Switch Restaurant</button>
    </form>
  </div>
</div>

<form method="post" style="max-width: 560px;" novalidate id="order-form">
  {% csrf_token %}

  {% if form.non_field_errors %}
  <div class="notification is-danger is-light">
    {% for error in form.non_field_errors %}
    <p>{{ error }}</p>
    {% endfor %}
  </div>
  {% endif %}

  <div class="field">
    <label class="label">{{ form.people.label }}</label>
    <p class="help mb-2">Select additional group members to include (you are always included).</p>
    <p id="people-count" class="help mb-2 has-text-weight-semibold"></p>

    <div id="people-tags"
         hx-get="{% url 'order_people_partial' proto_order.pk %}"
         hx-trigger="every 4s"
         hx-swap="innerHTML"
         style="display:flex; flex-wrap:wrap; gap:0.4rem;
                border:1px solid #dbdbdb; border-radius:4px; padding:0.5rem;">
      {% include "webapp/_people_tags_partial.html" %}
    </div>

    {% if form.people.errors %}
    <p class="help is-danger">{% for e in form.people.errors %}{{ e }}{% endfor %}</p>
    {% endif %}
  </div>

  {% include "webapp/_num_pizzas_field.html" %}

  {{ form.optimization_mode }}

  <div class="field">
    <div class="control">
      <button class="button is-primary" type="submit">Generate Pizza Order</button>
    </div>
  </div>
</form>

{% include "webapp/_loading_overlay.html" %}

<style>
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
input[type="number"] { -moz-appearance: textfield; }
</style>
<script src="{% static 'webapp/js/order_loading_overlay.js' %}"></script>
<script src="{% static 'webapp/js/order_people_tags.js' %}"></script>
<script src="{% static 'webapp/js/order_draft.js' %}"></script>

{% endblock %}
