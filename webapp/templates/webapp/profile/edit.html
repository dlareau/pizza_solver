{% extends "webapp/base.html" %}
{% block title %}My Preferences{% endblock %}

{% block content %}
<h1 class="title">My Preferences</h1>

<form method="post" style="max-width: 680px;">
  {% csrf_token %}

  {% if form.non_field_errors %}
  <div class="notification is-danger is-light">
    {% for error in form.non_field_errors %}<p>{{ error }}</p>{% endfor %}
  </div>
  {% endif %}

  <div class="field">
    <label class="label" for="{{ form.name.id_for_label }}">{{ form.name.label }}</label>
    <div class="control">
      <input class="input{% if form.name.errors %} is-danger{% endif %}"
             type="text"
             name="{{ form.name.html_name }}"
             id="{{ form.name.id_for_label }}"
             value="{{ form.name.value|default:'' }}">
    </div>
    {% if form.name.errors %}
    <p class="help is-danger">{% for e in form.name.errors %}{{ e }}{% endfor %}</p>
    {% endif %}
  </div>

  <div class="field">
    <label class="label" for="{{ form.email.id_for_label }}">{{ form.email.label }}</label>
    <div class="control">
      <input class="input{% if form.email.errors %} is-danger{% endif %}"
             type="email"
             name="{{ form.email.html_name }}"
             id="{{ form.email.id_for_label }}"
             value="{{ form.email.value|default:'' }}">
    </div>
    {% if form.email.errors %}
    <p class="help is-danger">{% for e in form.email.errors %}{{ e }}{% endfor %}</p>
    {% endif %}
  </div>

  <div class="field">
    <label class="checkbox">
      <input type="checkbox"
             name="{{ form.unrated_is_dislike.html_name }}"
             id="{{ form.unrated_is_dislike.id_for_label }}"
             {% if form.unrated_is_dislike.value %}checked{% endif %}>
      {{ form.unrated_is_dislike.label }}
    </label>
    <p class="help">If checked, toppings you haven't rated are treated as dislikes when optimizing.</p>
  </div>

  <hr>

  {% if toppings %}
  <h2 class="subtitle mb-2">Topping Preferences</h2>

  {% for topping in toppings %}
  <div class="is-flex is-align-items-center mb-2" style="gap: 0.75rem;">
    <span style="min-width: 10rem;">{{ topping.name }}</span>
    <div class="buttons has-addons mb-0" data-topping="{{ topping.pk }}">

      <button type="button" data-value="allergy"
              class="button is-small pref-btn {% if topping.pk in allergy_ids %}is-danger{% else %}is-light{% endif %}">
        Allergy
      </button>

      <button type="button" data-value="dislike"
              class="button is-small pref-btn {% if topping.pk in dislike_ids %}is-warning{% else %}is-light{% endif %}">
        Dislike
      </button>

      <button type="button" data-value="neutral"
              class="button is-small pref-btn {% if topping.pk not in allergy_ids and topping.pk not in dislike_ids and topping.pk not in like_ids %}is-info is-light{% else %}is-light{% endif %}">
        Neutral
      </button>

      <button type="button" data-value="like"
              class="button is-small pref-btn {% if topping.pk in like_ids %}is-success{% else %}is-light{% endif %}">
        Like
      </button>

    </div>
    <input type="hidden" name="pref_{{ topping.pk }}"
           value="{% if topping.pk in allergy_ids %}allergy{% elif topping.pk in dislike_ids %}dislike{% elif topping.pk in neutral_ids %}neutral{% elif topping.pk in like_ids %}like{% endif %}">
  </div>
  {% endfor %}

  {% else %}
  <p class="has-text-grey">No toppings have been added yet.</p>
  {% endif %}

  <div class="field mt-5">
    <div class="control">
      <button class="button is-primary" type="submit">Save Preferences</button>
    </div>
  </div>
</form>

<script>
(function () {
  // Maps a preference value to the Bulma colour modifier applied when selected.
  // Neutral ('') gets is-info + is-light for a soft tint rather than a saturated colour.
  var COLOR = { allergy: 'is-danger', dislike: 'is-warning', neutral: 'is-info', like: 'is-success' };

  document.querySelectorAll('.buttons[data-topping]').forEach(function (group) {
    var hidden = document.querySelector('input[name="pref_' + group.dataset.topping + '"]');

    group.querySelectorAll('.pref-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var val = btn.dataset.value;

        // Reset every button in this bar to the unselected state
        group.querySelectorAll('.pref-btn').forEach(function (b) {
          b.className = 'button is-small pref-btn is-light';
        });

        // Apply the selected state to the clicked button
        btn.classList.remove('is-light');
        btn.classList.add(COLOR[val]);
        if (val === 'neutral') {
          // Neutral: restore is-light so the colour becomes a soft tint not a solid fill
          btn.classList.add('is-light');
        }

        hidden.value = val;
      });
    });
  });
}());
</script>
{% endblock %}
