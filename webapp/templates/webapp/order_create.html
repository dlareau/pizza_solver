{% extends "webapp/base.html" %}
{% block title %}New Pizza Order{% endblock %}

{% block extra_head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://unpkg.com/htmx.org@2.0.4/dist/htmx.min.js"></script>
{% endblock %}

{% block content %}
<h1 class="title">New Pizza Order</h1>
<p class="subtitle">Ordering as: <strong>{{ host.name }}</strong></p>

{% if not selected_group %}

{# Step 1: pick a group #}
<form method="get" action="" style="max-width: 400px;">
  <div class="field">
    <label class="label">Select a Group</label>
    <div class="control">
      <div class="select is-fullwidth">
        <select name="group">
          <option value="">-- Select a group --</option>
          {% for group in groups %}
          <option value="{{ group.pk }}">{{ group.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>
  <div class="field">
    <div class="control">
      <button class="button is-primary" type="submit">Continue</button>
    </div>
  </div>
</form>

{% else %}

{# Step 2: full order form #}
<p class="mb-4">
  <strong>Group:</strong> {{ selected_group.name }}
  {% if can_change_group %}
  <a class="ml-3 is-size-7" href="{% url 'create_order' %}">Change group</a>
  {% endif %}
</p>

{% if proto_order and invite_url %}
<div class="box" style="max-width:560px;">
  <h3 class="subtitle is-6 mb-2">One-Time Guest Link</h3>
  <p class="help mb-3">Share this link with one-time guests to set their topping preferences. For regular guests, invite them to the group instead.</p>
  <div class="field has-addons">
    <div class="control is-expanded">
      <input id="invite-link" class="input is-small" type="text" readonly value="{{ invite_url }}">
    </div>
    <div class="control">
      <button class="button is-info is-small" type="button"
              onclick="navigator.clipboard.writeText(document.getElementById('invite-link').value);
                       this.textContent='Copied!';setTimeout(()=>this.textContent='Copy',2000);">
        Copy
      </button>
    </div>
  </div>
  <div id="qr-section" class="mt-3" style="display:none;">
    <div id="qr-canvas"></div>
  </div>
</div>
{% endif %}

{% if proto_order %}
{# Restaurant locked section — separate form to avoid nesting #}
<div class="field" style="max-width:560px;">
  <label class="label">Restaurant</label>
  <div class="is-flex is-align-items-center" style="gap: 0.75rem;">
    <span class="is-size-6">{{ proto_order.restaurant }}</span>
    <form method="post" action="{% url 'order_cancel_invite' proto_order.id %}"
          onsubmit="return confirm('Switching restaurant will remove all guests and their preferences. Are you sure?');"
          style="display:inline; margin:0;">
      {% csrf_token %}
      <button class="button is-warning is-outlined is-small" type="submit">Switch Restaurant</button>
    </form>
  </div>
</div>
{% endif %}

<form method="post" style="max-width: 560px;" novalidate id="order-form">
  {% csrf_token %}
  {{ form.group }} {# hidden input #}
  {% if proto_order %}
  <input type="hidden" name="proto_order_id" value="{{ proto_order.pk }}">
  {{ form.restaurant }} {# hidden input — locked restaurant #}
  {% else %}

  <div class="field">
    <label class="label" for="{{ form.restaurant.id_for_label }}">{{ form.restaurant.label }}</label>
    <div class="control">
      <div class="select is-fullwidth">
        {{ form.restaurant }}
      </div>
    </div>
    {% if form.restaurant.errors %}
    <p class="help is-danger">{% for e in form.restaurant.errors %}{{ e }}{% endfor %}</p>
    {% endif %}
  </div>

  <div class="field mt-2">
    <button class="button is-info is-outlined" type="submit" name="invite_guests" value="1"
            id="invite-guests-btn" disabled>
      Invite One-Time Guests
    </button>
    <p class="help">Generates a shareable link for one-time guests to set their preferences (restaurant cannot be changed after this).</p>
  </div>

  {% endif %}

  {% if form.non_field_errors %}
  <div class="notification is-danger is-light">
    {% for error in form.non_field_errors %}
    <p>{{ error }}</p>
    {% endfor %}
  </div>
  {% endif %}

  <div class="field">
    <label class="label">{{ form.people.label }}</label>
    <p class="help mb-2">Select additional group members to include (you are always included).</p>
    <p id="people-count" class="help mb-2 has-text-weight-semibold"></p>

    <div id="people-tags"
         {% if proto_order %}
         hx-get="{% url 'order_people_partial' proto_order.pk %}"
         hx-trigger="every 4s"
         hx-swap="innerHTML"
         {% endif %}
         style="display:flex; flex-wrap:wrap; gap:0.4rem;
                border:1px solid #dbdbdb; border-radius:4px; padding:0.5rem;">
      {% include "webapp/_people_tags_partial.html" %}
    </div>

    {% if form.people.errors %}
    <p class="help is-danger">{% for e in form.people.errors %}{{ e }}{% endfor %}</p>
    {% endif %}
  </div>

  <div class="field">
    <label class="label" for="{{ form.num_pizzas.id_for_label }}">{{ form.num_pizzas.label }}</label>
    <div class="field has-addons" style="max-width:200px;">
      <div class="control">
        <button type="button" class="button" id="pizzas-dec">−</button>
      </div>
      <div class="control is-expanded">
        <input class="input" style="text-align:center;" type="number"
               name="{{ form.num_pizzas.html_name }}"
               id="{{ form.num_pizzas.id_for_label }}"
               value="{{ form.num_pizzas.value|default:1 }}"
               min="1">
      </div>
      <div class="control">
        <button type="button" class="button" id="pizzas-inc">+</button>
      </div>
    </div>
    {% if form.num_pizzas.errors %}
    <p class="help is-danger">{% for e in form.num_pizzas.errors %}{{ e }}{% endfor %}</p>
    {% endif %}
  </div>

  <div class="field">
    <label class="label" for="{{ form.optimization_mode.id_for_label }}">{{ form.optimization_mode.label }}</label>
    <div class="control">
      <div class="select">
        {{ form.optimization_mode }}
      </div>
    </div>
    {% if form.optimization_mode.errors %}
    <p class="help is-danger">{% for e in form.optimization_mode.errors %}{{ e }}{% endfor %}</p>
    {% endif %}
  </div>

  <div class="field">
    <div class="control">
      <button class="button is-primary" type="submit">Generate Pizza Order</button>
    </div>
  </div>
</form>

<div id="loading-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; flex-direction:column; align-items:center; justify-content:center; gap:1.5rem;">
  <p class="title">Optimizing your pizza order&hellip;</p>
  <p class="subtitle has-text-grey">This may take up to 20 seconds.</p>
  <div style="width:min(480px,80vw); background:#dbdbdb; border-radius:4px; height:14px; overflow:hidden;">
    <div id="loading-bar" style="height:100%; width:0%; background:#3273dc; border-radius:4px;"></div>
  </div>
</div>

<style>
input[type="number"]::-webkit-inner-spin-button,
input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
input[type="number"] { -moz-appearance: textfield; }
#invite-guests-btn:disabled {
  background-color: transparent !important;
  opacity: 0.45;
  cursor: not-allowed;
}
</style>

<script>
(function () {
  var countEl = document.getElementById('people-count');

  function updateCount() {
    var n = document.querySelectorAll('#people-tags input[type="checkbox"]:checked').length;
    countEl.textContent = n + ' ' + (n === 1 ? 'person' : 'people') + ' selected';
  }

  function initPeopleTags() {
    document.querySelectorAll('#people-tags label').forEach(function (lbl) {
      var cb = lbl.querySelector('input[type="checkbox"]');
      var tag = lbl.querySelector('.person-tag');
      if (!cb || !tag) return;
      if (cb.checked) {
        tag.classList.replace('is-light', 'is-link');
      } else {
        tag.classList.replace('is-link', 'is-light');
      }
      lbl.addEventListener('click', function (e) {
        e.preventDefault();
        cb.checked = !cb.checked;
        if (cb.checked) {
          tag.classList.replace('is-light', 'is-link');
        } else {
          tag.classList.replace('is-link', 'is-light');
        }
        updateCount();
      });
    });
    updateCount();
  }

  initPeopleTags();

  {% if proto_order %}
  document.addEventListener('htmx:beforeSwap', function (e) {
    if (e.detail.target.id === 'people-tags') {
      var state = {};
      e.detail.target.querySelectorAll('input[type="checkbox"]').forEach(function (cb) {
        state[cb.value] = cb.checked;
      });
      window._savedPeopleState = state;
    }
  });

  document.addEventListener('htmx:afterSwap', function (e) {
    if (e.detail.target.id === 'people-tags') {
      var saved = window._savedPeopleState || {};
      e.detail.target.querySelectorAll('input[type="checkbox"]').forEach(function (cb) {
        if (cb.value in saved) {
          cb.checked = saved[cb.value];
        }
        // new people not in saved → keep server default (checked, since they're in order.people)
      });
      initPeopleTags();
    }
  });
  {% endif %}
}());

document.getElementById('pizzas-dec').addEventListener('click', function () {
  var input = document.getElementById('{{ form.num_pizzas.id_for_label }}');
  var val = parseInt(input.value, 10) || 1;
  if (val > 1) input.value = val - 1;
});
document.getElementById('pizzas-inc').addEventListener('click', function () {
  var input = document.getElementById('{{ form.num_pizzas.id_for_label }}');
  var val = parseInt(input.value, 10) || 1;
  input.value = val + 1;
});

document.getElementById('order-form').addEventListener('submit', function (e) {
  {% if not proto_order %}
  document.querySelectorAll('[data-client-error]').forEach(function (el) { el.remove(); });

  function showError(anchorEl, message) {
    var p = document.createElement('p');
    p.className = 'help is-danger';
    p.setAttribute('data-client-error', '');
    p.textContent = message;
    anchorEl.insertAdjacentElement('afterend', p);
    return p;
  }

  var firstError = null;
  var restaurantSelect = document.querySelector('select[name="{{ form.restaurant.html_name }}"]');
  if (!restaurantSelect.value) {
    firstError = showError(restaurantSelect.closest('.control'), 'Please select a restaurant.');
  }

  if (firstError) {
    e.preventDefault();
    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
    return;
  }

  // Only show the loading overlay for the main "Generate" submit, not "Invite Guests"
  if (!e.submitter || e.submitter.name !== 'invite_guests') {
  {% endif %}
    var overlay = document.getElementById('loading-overlay');
    var bar = document.getElementById('loading-bar');
    overlay.style.display = 'flex';
    bar.getBoundingClientRect();
    bar.style.transition = 'width 20s linear';
    bar.style.width = '100%';
  {% if not proto_order %}
  }
  {% endif %}
});

{% if not proto_order %}
(function () {
  var restaurantSelect = document.getElementById('{{ form.restaurant.id_for_label }}');
  var inviteBtn = document.getElementById('invite-guests-btn');
  function toggleInvite() {
    inviteBtn.disabled = !restaurantSelect.value;
  }
  restaurantSelect.addEventListener('change', toggleInvite);
  toggleInvite();
}());
{% endif %}

(function () {
  var qrDiv   = document.getElementById('qr-canvas');
  var section = document.getElementById('qr-section');
  var linkEl  = document.getElementById('invite-link');
  var url     = linkEl && linkEl.value;
  if (!qrDiv || !url) return;
  section.style.display = 'block';
  new QRCode(qrDiv, { text: url, width: 128, height: 128, correctLevel: QRCode.CorrectLevel.L });
}());
</script>

{% endif %}
{% endblock %}
