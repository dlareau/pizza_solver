{% extends "webapp/base.html" %}
{% block title %}New Pizza Order{% endblock %}

{% block content %}
<h1 class="title">New Pizza Order</h1>
<p class="subtitle">Ordering as: <strong>{{ host.name }}</strong></p>

<form method="post" style="max-width: 560px;">
  {% csrf_token %}

  {% if form.non_field_errors %}
  <div class="notification is-danger is-light">
    {% for error in form.non_field_errors %}
    <p>{{ error }}</p>
    {% endfor %}
  </div>
  {% endif %}

  <div class="field">
    <label class="label" for="{{ form.vendor.id_for_label }}">{{ form.vendor.label }}</label>
    <div class="control">
      <div class="select is-fullwidth">
        {{ form.vendor }}
      </div>
    </div>
    {% if form.vendor.errors %}
    <p class="help is-danger">{% for e in form.vendor.errors %}{{ e }}{% endfor %}</p>
    {% endif %}
  </div>

  <div class="field">
    <label class="label">{{ form.people.label }}</label>
    <div class="control">
      {% for choice in form.people %}
      <label class="checkbox" style="display:block; margin-bottom:0.3rem;">
        {{ choice.tag }} {{ choice.choice_label }}
      </label>
      {% endfor %}
    </div>
    {% if form.people.errors %}
    <p class="help is-danger">{% for e in form.people.errors %}{{ e }}{% endfor %}</p>
    {% endif %}
  </div>

  <div class="field">
    <label class="label" for="{{ form.num_pizzas.id_for_label }}">{{ form.num_pizzas.label }}</label>
    <div class="control">
      <input class="input" style="max-width:200px;" type="number"
             name="{{ form.num_pizzas.html_name }}"
             id="{{ form.num_pizzas.id_for_label }}"
             value="{{ form.num_pizzas.value|default:1 }}"
             min="1">
    </div>
    {% if form.num_pizzas.errors %}
    <p class="help is-danger">{% for e in form.num_pizzas.errors %}{{ e }}{% endfor %}</p>
    {% endif %}
  </div>

  <div class="field">
    <label class="label" for="{{ form.optimization_mode.id_for_label }}">{{ form.optimization_mode.label }}</label>
    <div class="control">
      <div class="select">
        {{ form.optimization_mode }}
      </div>
    </div>
    {% if form.optimization_mode.errors %}
    <p class="help is-danger">{% for e in form.optimization_mode.errors %}{{ e }}{% endfor %}</p>
    {% endif %}
  </div>

  <div class="field">
    <div class="control">
      <button class="button is-primary" type="submit">Generate Pizza Order</button>
    </div>
  </div>
</form>

<div class="box mt-5" style="max-width:560px;">
  <p class="subtitle is-6">Invite guests to set their preferences</p>
  <div class="field has-addons">
    <div class="control is-expanded">
      <input id="invite-link" class="input is-small" type="text" readonly
             value="{{ request.scheme }}://{{ request.get_host }}{% url 'guest_setup' %}">
    </div>
    <div class="control">
      <button class="button is-small is-info" type="button"
              onclick="navigator.clipboard.writeText(document.getElementById('invite-link').value);
                       this.textContent='Copied!';setTimeout(()=>this.textContent='Copy',2000);">
        Copy
      </button>
    </div>
  </div>
</div>

<div id="loading-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; flex-direction:column; align-items:center; justify-content:center; gap:1.5rem;">
  <p class="title">Optimizing your pizza order&hellip;</p>
  <p class="subtitle has-text-grey">This may take up to 20 seconds.</p>
  <div style="width:min(480px,80vw); background:#dbdbdb; border-radius:4px; height:14px; overflow:hidden;">
    <div id="loading-bar" style="height:100%; width:0%; background:#3273dc; border-radius:4px;"></div>
  </div>
</div>

<script>
document.querySelector('form').addEventListener('submit', function () {
  var overlay = document.getElementById('loading-overlay');
  var bar = document.getElementById('loading-bar');
  overlay.style.display = 'flex';
  // Force a synchronous layout flush so the browser commits width:0% before
  // we set the transition â€” without this the start state gets skipped.
  bar.getBoundingClientRect();
  bar.style.transition = 'width 20s linear';
  bar.style.width = '100%';
});
</script>
{% endblock %}
